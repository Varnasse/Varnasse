# EC2 High Availability and Scalability

### Scalability & High Availability

* Scalability means that an application / system can handle greater loads by adapting
* There are two kinds of scalability:
  * Vertical scalability
  * Horizontal scalability
* Scalability is linked but different to High Availability

#### Vertical Scalability

* This means increasing the size of the instance
* For example, your application runs a t2.micro and we can scale this up to t2.large
* Vertical scalability is common for non-distributed systems, such as a database

#### Horizontal Scalability

* This means increasing the number of instances / systems for your application
* This implies distributed systems

#### High Availability

* High availability usually goes hand in hand with horizontal scaling
* This means running your applications / system in at least 2 data centres (== availability zones)
* The goal of high availability is to survive a data centre loss

### Elastic Load Balancing

* Load balancers are servers that forward traffic to multiple servers (EC2 instances) downstream
* They allow a single point of access to your application
* Seamlessly handle failures of downstream instances
* Do regular health checks to your instances
* Provide SSL termination (HTTPS) for your websites
* Enforce stickiness with cookies
* Separate public traffic from private traffic

#### Types of Load balancer on AWS

* Classic
  * HTTP, HTTPS, TCP, SSL
* Application
  * HTTP, HTTPS, WebSocket
* Network
  * TCP, TLS, UDP
* Gateway
  * Operates at layer 3 (network layer) - IP protocol

### Application Load Balancer (v2)

* It is a layer 7 load balancer (HTTP)
* Load balancing to multiple HTTP applications across machines (target groups)
* Load balancing to multiple applications on the same machine (containers)
* Support for HTTP/2 and WebSocket
* Support redirects
* Routing tables to different target groups:
  * Routing based on path in URL
  * Routing based on hostname in URL
  * Routing based on Query String, Headers

### Network Load Balancer (v2)

* It is a layer 4 load balancer
  * Forward TCP & UDP traffic
  * Handle millions of requests per second
  * Less latency
* NLB has one static IP per AZ and supports assigning elastic IP (helpful for whitelisting specific IP)
* NLB are used for extreme performance, TCP or UDP traffic
* Not included in AWS free tier
* Health checks support the TCP, HTTP and HTTPS protocols&#x20;

### Gateway Load Balancer

* Deploy, scale and manage a fleet of 3rd party network virtual appliances in AWS
* Example: firewalls, intrusion detection and prevention systems, deep packet inspection systems, payload manipulation
* Operates at layer 3 (network layer) - IP packets
* Combines the following functions:
  * Transparent Network Gateway - single entry/exit for all traffic
  * Load balancer - distributes traffic to your virtual appliances
* Uses the GENEVE protocol on port 6081

### Sticky Sessions (Session Affinity)

* It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
* The "cookie" used for stickiness has an exiration date you control
* Use case: make sure the user doesn't lose his session data

#### Sticky Sessions - Cookie Names

* Application-based cookies
  * Custom cookie
    * generated by target
    * Can include any custom attributes required by the app
    * Cookie name must be specific individually for each target group
  * Application cookie
    * Generated by the load balancer
    * Cookie name is AWSALBAPP
* Duration-based cookies
  * Cookie generated by the load balancer
  * Cookie name is AWSALB for ALB, AWSELB for CLB

### Cross-Zone Load Balancing

* Each load balancer instance distributes evenly across all registered instances in all AZ
* Application Load Balancer
  * Enabled by default (can be disabled at the target group level)
  * No charges for inter AZ data
* Network and Gateway load balancer
  * Disabled by default
  * You pay charges for inter AZ data if enabled

### SSL/TLS - Basics

* An SSL certificate allows traffic between your client and your load balancer to be encrypted in transit
* SSL refers to Secure Sockets Layer
* TLS refers to Transport Layer Security
* Nowadays, TLS certificates are mainly used

#### SSL - Server Name Indication

* SNI solves the problem of loading multiple SSL certificates onto one web server
* It's a "newer" protocol and requires the client to indicate the hostname of the target server in the initial SSL handshake
* The server will then find the correct certificate or return the default one

### Connection Draining

* Feature Naming
  * Connection draining - for CLB
  * Deregistration delay - for ALB and NLB
* Time to complete "in-flight requests" while the instance is de-registering or unhealthy
* Stops sending new requests to the EC2 instance which is de-registering
* Can be set between 1 to 3600 seconds (default: 300)
* Can be disabled (Set value to 0)
* Set to a low value if your requests are short

### Target Group Attributes

#### Slow Start Mode

* By default, a target recieves its full share of requests once it's registered with the target group
* Slow Start Mode gives healthy targets time to warm-up before the load balancer sends them a full share of requests
* The load balancer linearly increases the number of requests that it sends to the target

#### Request Routing Algorithm - Least Outstanding Requests

* The next instance to receive the request is the instance that has the lowest number of pending/unfinished requests
* Works with Application Load Balancer and Classic Load Balancer

#### Request Routing Algorithms - Round Robin

* Equally choose the targets from the target group
* Works with ALB and CLB

#### Request Routing Algorithms - Flow Hash

* Selects a target based on the protocol, source/desitination IP address, source/destination port, and TCP sequence number
* Each TCP/UDP connection is routed to a single target for the life of the connection
* Works with Network Load Balancer

### ALB - Listener Rules

* Processed in order (with default rule)
* Supported actions (forward, redirect, fixed-response)
* Rule conditions:
  * host-header
  * http-request-method
  * path-pattern
  * source-ip
  * http-header
  * query-string

#### Target Group Weighting

* Specify weight for each Target Group on a single rule
* Example: multiple versions of your app, blue/green deployment
* Allows you to control the distribution of the traffic to your applications

### Auto Scaling Group

* The goal of an auto scaling group is to:
  * Scale out to match increased load
  * Scale in (remove instances) to match a decreased load
  * Ensure we have a min and max number of instances running
  * Automatically register new instances to a load balancer
  * Re-create an EC2 instance in case a previous one is terminated (ex: if unhealthy)
* ASG are frree (you only pay for the underlying EC2 instances)

#### Attributes

* A Launch Template
  * AMI + Instance type
  * EC2 user data
  * EBS volumes
  * Security groups
  * SSH key pair
  * IAM roles
  * Network and subnet information
  * Load balancer information
* Min size/ Max size/ Initial capacity

### Lifecycle Hooks

* By default, as soon as an instance is launched in an ASG, it's in service
* You can perform extra steps before the instance goes in service (pending state)
  * Define a script to run on the instances as they start
* You can perform some action before the instance is terminated (terminating state)
  * Pause the instances before they're terminated for troubleshooting
* Use cases: clean-up, log extraction, special health checks&#x20;
* Integration with EventBridge, SNS and SQS

#### Troubleshooting ASG issue

* \<number of instances> instance(s) are already running.
  * The auto scaling group has reached the limit set by the MaximumCapacity parameter.
* Launching EC2 instances is failing:
  * The security group does not exist or deleted
* If the ASG fails to launch an instance for over 24 hours, it will automatically suspend the processes

### CloudWatch for ASG

* Metrics are collected every 1 minute
*   ASG-level metrics (opt-in):

    * GroupMinSize, GroupMaxSize



### AWS Auto Scaling

* Backbone service of auto scaling for scalable resources in AWS
* Amazon EC2 auto scaling groups: launch or terminate EC2 instances
* Amazon EC2 Spot Fleet requests: Launch or terminate instances from a spot fleet request, or automatically replace instances that get interrupted for price or capacity reasons
* Amazon ECS: adjust the ECS service desired count up or down
* Amazon DynamoDB
* Amazon Aurora: Dynamic Read Replicas Auto Scaling

#### Dynamic Scaling

* Creates a target tracking scaling policy
  * Optimise for availability
  * Optimise for cost
  * Custom

#### Predictive Scaling

* Continuously forecast load and schedule scaling ahead&#x20;
